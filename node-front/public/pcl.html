<html>
<head>
  <!-- vue is an overkill for this, and I am pretty sure I am not doing it right :( -->
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nanomsg-browser@0.1.6/dist/nanomsg.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/msgpack-lite@0.1.26/dist/msgpack.min.js"></script>
  <script src="https://threejs.org/build/three.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
</head>
<body>
  <div id="app" style="margin: 25px">
  </div>
  <div id="WebGL-output">
  </div>
<script>
//--
const app = new Vue({
  el: '#app',
  data: {
    sub: new nanomsg.Socket(nanomsg.SUB),
    dec: new msgpack.Decoder(),
  },
  methods: {
    fromBuf(buf) {
      // feed decoder stream
      this.dec.decode(new Uint8Array(buf));
    },
    fromList(list) {
      const geom = new THREE.Geometry();
      const material = new THREE.PointCloudMaterial({
        size: 1,
        vertexColors: true,
      });
      list.forEach((e) => {
        const particle = new THREE.Vector3(e[0], e[1], e[2]);
        geom.vertices.push(particle);
        const color = new THREE.color(0);
        geom.colors.push(color);
      });
      const cloud = new THREE.PointCloud(geom, material);
      cloud.name = "particles";
      this.scene.add(cloud);
      requestAnimationFrame(() => {
        webGLRenderer.render(this.scene, this.camera);
      });
    },
    pcl() {
      var scene = new THREE.Scene();
      var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
      var webGLRenderer = new THREE.WebGLRenderer();
      webGLRenderer.setClearColor(new THREE.Color(0x000000, 1.0));
      webGLRenderer.setSize(window.innerWidth, window.innerHeight);
      camera.position.x = 20;
      camera.position.y = 0;
      camera.position.z = 150;
      document.getElementById("WebGL-output").appendChild(webGLRenderer.domElement);

        if (scene.getObjectByName("particles")) {
            scene.remove(scene.getObjectByName("particles"));
        }
        createParticles();

    render();

    function createParticles() {
        var geom = new THREE.Geometry();
        var material = new THREE.PointCloudMaterial({
            size: 4,
            vertexColors: true,
        });

        var range = 10;
        for (var i = 0; i < 150; i++) {
            var particle = new THREE.Vector3(Math.random() * range - range / 2, Math.random() * range - range / 2, Math.random() * range - range / 2);
            geom.vertices.push(particle);
            var color = new THREE.Color(0x000000);
            geom.colors.push(color);
        }

        cloud = new THREE.PointCloud(geom, material);
        cloud.name = "particles";
        scene.add(cloud);
    }

    var step = 0;

    function render() {

        requestAnimationFrame(render);
        webGLRenderer.render(scene, camera);
    }

    },
  },
  mounted() {
    $.getJSON('/fresa/config', (config) => {
      this.pcl();

      this.config = config;

      // prevent conversion to string
      nanomsg.receiveArrayBuffer = true;
      this.sub.on('data', this.fromBuf);
      this.dec.on('data', this.fromList);

      this.sub
        .connect(`ws://${location.host}/fresa/ws/9200`);
    });
  },
});
//--
  </script>
</body>
    
</html>
