<html>
<head>
  <!-- vue is an overkill for this, and I am pretty sure I am not doing it right :( -->
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nanomsg-browser@0.1.6/dist/nanomsg.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/msgpack-lite@0.1.26/dist/msgpack.min.js"></script>
  <script src="https://threejs.org/build/three.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
</head>
<body>
  <div id="app" style="margin: 25px">
  </div>
  <div id="WebGL-output">
  </div>
<script>
//--
const app = new Vue({
  el: '#app',
  data: {
    gl: {},
    sub: new nanomsg.Socket(nanomsg.SUB),
    dec: new msgpack.Decoder(),
  },
  methods: {
    fromBuf(buf) {
      // feed decoder stream
      this.dec.decode(new Uint8Array(buf));
    },
    fromList(list) {
      const { scene, camera, webGLRenderer } = this.gl;
      if (scene.getObjectByName("particles")) {
        scene.remove(scene.getObjectByName("particles"));
      }
      const geom = new THREE.Geometry();
      const material = new THREE.PointsMaterial({
        size: 1,
        vertexColors: true,
      });
      list.forEach((e) => {
        const particle = new THREE.Vector3(e[0], e[1], e[2]);
        geom.vertices.push(particle);
        const color = new THREE.Color(e[3], e[4], e[5]);
        geom.colors.push(color);
      });
      const cloud = new THREE.Points(geom, material);
      cloud.name = "particles";
      scene.add(cloud);
      requestAnimationFrame(() => {
        webGLRenderer.render(scene, camera);
      });
    },
    initGl() {
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(60, 1.0, 0.1, 1000);
      camera.position.set(20, 20, 20);
      camera.lookAt(0, 0, 0);
      const webGLRenderer = new THREE.WebGLRenderer();
      webGLRenderer.setClearColor(new THREE.Color(0x000000, 1.0));
      webGLRenderer.setSize(600, 600);
      document.getElementById("WebGL-output").appendChild(webGLRenderer.domElement);
      this.gl = { scene, camera, webGLRenderer };
    },
  },
  mounted() {
    this.initGl();

    $.getJSON('/fresa/config', (config) => {
      this.config = config;

      // prevent conversion to string
      nanomsg.receiveArrayBuffer = true;
      this.sub.on('data', this.fromBuf);
      this.dec.on('data', this.fromList);

      this.sub
        .connect(`ws://${location.host}/fresa/ws/9200`);
    });
  },
});
//--
  </script>
</body>
    
</html>
